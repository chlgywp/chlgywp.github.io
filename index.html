<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대건온순환 | 우리 학교 장터</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb; --dark: #111827; --gray: #6b7280;
            --light: #f3f4f6; --white: #ffffff; --border: #e5e7eb; --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { 
            font-family: 'Pretendard', sans-serif; background-color: var(--white); 
            color: var(--dark); padding-top: 60px; min-height: 100vh; display: flex; flex-direction: column; 
        }

        .container { 
            max-width: 1200px; margin: 0 auto; padding: 30px 20px; 
            display: none; width: 100%; flex-grow: 1;
        }
        .container.active { display: block !important; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; 
            padding: 0 5%; z-index: 1000;
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--dark); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .logo i { color: var(--primary); } 

        .nav-group { display: flex; gap: 20px; height: 100%; }
        .nav-item { display: flex; align-items: center; height: 100%; font-weight: 600; color: var(--gray); cursor: pointer; position: relative; }
        .nav-item.active { color: var(--dark); border-bottom: 2px solid var(--dark); }
        .nav-item.active-donate { color: var(--primary); border-bottom: 2px solid var(--primary); }

        .filter-wrapper { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 10px; scrollbar-width: none; }
        .filter-wrapper::-webkit-scrollbar { display: none; }
        .filter-chip { 
            padding: 8px 18px; border-radius: 50px; border: 1px solid var(--border); 
            background: white; color: var(--gray); font-size: 0.9rem; font-weight: 500; cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .filter-chip.selected { background: var(--dark); color: white; border-color: var(--dark); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; }
        .card { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; transition: 0.2s; cursor: pointer; }
        .card:hover { transform: translateY(-5px); }
        .card-img-box { width: 100%; aspect-ratio: 1/1; background: var(--light); position: relative; border-radius: 8px; overflow: hidden; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { padding: 15px 0; }
        .card-tag { font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 4px; }
        .card-title { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
        .card-price { font-weight: 800; font-size: 1.1rem; }

        #login-screen { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .fab { position: fixed; bottom: 40px; right: 40px; width: 60px; height: 60px; border-radius: 50%; background: var(--dark); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; z-index: 900; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        /* 글쓰기 입력창 스타일 */
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-top: 5px; }
        .write-label { display: block; font-weight: 700; margin-top: 15px; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        .btn-main { flex: 2; padding: 15px; background: var(--dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
        .btn-sub { flex: 1; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
        
        .dev-footer { text-align: center; padding: 25px 0; font-size: 0.85rem; color: var(--gray); border-top: 1px solid var(--border); margin-top: auto; }
    </style>
</head>
<body>
    
    <div id="login-screen">
        <h1 style="font-size: 2.5rem; font-weight: 800; color:var(--primary); margin-bottom: 10px;">대건온순환</h1>
        <p style="color: var(--gray); margin-bottom: 40px;">우리 학교 중고거래 & 나눔 플랫폼</p>
        <div id="g_id_onload"
            data-client_id="671092852945-06cb0vcctj58pjpf6gmcapk5voqc8h3e.apps.googleusercontent.com"
            data-callback="handleCredentialResponse"
            data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
        <div style="margin-top: 20px; color: var(--gray); cursor: pointer; text-decoration: underline; font-size: 0.9rem;" onclick="window.app.guestLogin()">게스트로 계속하기</div>
    </div>

    <header id="header" style="display:none;">
        <div class="logo" onclick="window.app.switchTab('trade')">
            <i class="fas fa-circle-nodes"></i> 대건온순환
        </div>
        <div class="nav-group">
            <div id="tab-trade" class="nav-item" onclick="window.app.switchTab('trade')">중고장터</div>
            <div id="tab-donate" class="nav-item" onclick="window.app.switchTab('donate')">기부·나눔</div>
        </div>
        <button class="btn-outline" style="padding: 6px 12px; border-radius: 6px; cursor:pointer; background:white; border:1px solid var(--border);" onclick="localStorage.clear();location.reload()">로그아웃</button>
    </header>

    <div id="screen-home" class="container">
        <div class="filter-wrapper">
            <span class="filter-chip selected" onclick="window.app.filter(this, 'all')">전체</span>
            <span class="filter-chip" onclick="window.app.filter(this, 'book')">도서/문제집</span>
            <span class="filter-chip" onclick="window.app.filter(this, 'tech')">전자기기</span>
            <span class="filter-chip" onclick="window.app.filter(this, 'life')">생활용품</span>
            <span class="filter-chip" onclick="window.app.filter(this, 'etc')">기타</span>
        </div>
        <input type="text" id="search" placeholder="찾으시는 물건이 있나요?" onkeyup="window.app.renderTrade()">
        <div id="trade-list" class="grid" style="margin-top:20px;"></div>
        <div class="fab" onclick="window.app.goWrite('trade')"><i class="fas fa-plus"></i></div>
    </div>

    <div id="screen-donate-home" class="container">
        <div style="background:var(--light); padding:24px; border-radius:12px; text-align:center; margin-bottom:30px;">
            <h3 style="color:var(--primary); margin-bottom:8px;">기부 천사가 되어주세요</h3>
            <p style="font-size:0.9rem; color:var(--gray)">따뜻한 마음을 나누는 공간입니다.</p>
        </div>
        <div id="donate-list" class="grid"></div>
        <div class="fab" style="background:var(--primary)" onclick="window.app.goWrite('donate')"><i class="fas fa-gift"></i></div>
    </div>

    <div id="screen-write" class="container">
        <div style="max-width: 600px; margin: 0 auto; background: white; padding: 20px;">
            <h2 id="write-title" style="font-weight: 800; margin-bottom: 10px;">물건 등록</h2>
            <hr style="border:0; border-top:1px solid var(--border); margin-bottom:20px;">
            
            <label class="write-label">상품 사진</label>
            <div onclick="document.getElementById('w-file').click()" style="border: 2px dashed var(--border); padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; color: var(--gray); margin-top:5px;">
                <i class="fas fa-camera" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>사진 업로드하기
            </div>
            <input type="file" id="w-file" accept="image/*" style="display:none;" onchange="window.app.preview(this)">
            <img id="w-img-preview" style="width:100%; margin-top:15px; border-radius:8px; display:none;">

            <label class="write-label">제목</label>
            <input type="text" id="w-title" placeholder="무엇을 판매하시나요?">

            <div id="price-group">
                <label class="write-label">판매 가격</label>
                <input type="number" id="w-price" placeholder="판매 가격 (원 단위)">
            </div>

            <label class="write-label">카테고리</label>
            <select id="w-cat">
                <option value="book">도서/문제집</option>
                <option value="tech">전자기기</option>
                <option value="life">생활용품</option>
                <option value="etc">기타</option>
            </select>

            <label class="write-label">오픈채팅 링크</label>
            <input type="text" id="w-link" placeholder="카카오톡 오픈채팅 주소를 넣어주세요">

            <div class="btn-group">
                <button class="btn-sub" onclick="window.app.switchTab(window.app.currentTab)">취소</button>
                <button class="btn-main" onclick="window.app.upload()">등록 완료</button>
            </div>
        </div>
    </div>

    <footer class="dev-footer">개발자 choihyoje</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://onsunhwan-default-rtdb.firebaseio.com",
            // TODO: 실제 apiKey 등을 여기에 입력하세요.
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getDatabase(fbApp);

        window.app = {
            user: null,
            products: [],
            currentTab: 'trade',
            currentCat: 'all',
            writeMode: 'trade',

            init: function() {
                onValue(ref(db, 'products'), (snapshot) => {
                    this.products = snapshot.val() ? Object.values(snapshot.val()) : [];
                    this.refresh();
                });
            },

            login: function() {
                this.user = localStorage.getItem('useremail');
                if(!this.user) return;
                document.getElementById('login-screen').style.setProperty('display', 'none', 'important');
                document.getElementById('header').style.setProperty('display', 'flex', 'important');
                this.switchTab('trade');
            },

            guestLogin: function() {
                localStorage.setItem('useremail', 'guest@daegon.hs.kr');
                this.login();
            },

            switchTab: function(tabName) {
                document.querySelectorAll('.container').forEach(c => {
                    c.classList.remove('active');
                    c.style.setProperty('display', 'none', 'important');
                });
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active', 'active-donate'));

                const targetId = (tabName === 'trade') ? 'screen-home' : 'screen-donate-home';
                const el = document.getElementById(targetId);
                if(el) { el.classList.add('active'); el.style.setProperty('display', 'block', 'important'); }
                
                document.getElementById((tabName === 'trade') ? 'tab-trade' : 'tab-donate').classList.add((tabName === 'trade') ? 'active' : 'active-donate');
                this.currentTab = tabName;
                this.refresh();
            },

            goWrite: function(mode) {
                this.writeMode = mode;
                document.querySelectorAll('.container').forEach(c => c.style.setProperty('display', 'none', 'important'));
                document.getElementById('screen-write').style.setProperty('display', 'block', 'important');
                
                // 폼 초기화
                document.getElementById('w-title').value = '';
                document.getElementById('w-price').value = '';
                document.getElementById('w-link').value = '';
                document.getElementById('w-img-preview').style.display = 'none';
                document.getElementById('price-group').style.display = (mode === 'donate') ? 'none' : 'block';
                document.getElementById('write-title').innerText = (mode === 'donate') ? '나눔 물건 등록' : '중고 물건 등록';
            },

            preview: function(input) {
                if(input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = document.getElementById('w-img-preview');
                        img.src = e.target.result;
                        img.style.display = 'block';
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            },

            upload: function() {
                const title = document.getElementById('w-title').value;
                const price = document.getElementById('w-price').value || 0;
                const cat = document.getElementById('w-cat').value;
                const link = document.getElementById('w-link').value;
                const img = document.getElementById('w-img-preview').src;

                if(!title || img.length < 100) return alert("사진과 제목을 입력해주세요.");

                const id = Date.now();
                set(ref(db, 'products/' + id), {
                    id: id, title, price, cat, link, img,
                    seller: this.user, type: this.writeMode
                }).then(() => {
                    alert("등록 완료!");
                    this.switchTab(this.writeMode);
                });
            },

            filter: function(el, cat) {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                this.currentCat = cat;
                this.refresh();
            },

            refresh: function() {
                this.currentTab === 'trade' ? this.renderTrade() : this.renderDonate();
            },

            renderTrade: function() {
                const list = document.getElementById('trade-list');
                const kw = document.getElementById('search').value.toLowerCase();
                let res = this.products.filter(p => p.type === 'trade');
                if(this.currentCat !== 'all') res = res.filter(p => p.cat === this.currentCat);
                if(kw) res = res.filter(p => p.title.toLowerCase().includes(kw));

                list.innerHTML = res.map(p => `
                    <div class="card" onclick="window.open('${p.link}')">
                        <div class="card-img-box"><img src="${p.img}" class="card-img"></div>
                        <div class="card-info">
                            <div class="card-tag">${p.cat}</div>
                            <div class="card-title">${p.title}</div>
                            <div class="card-price">${Number(p.price).toLocaleString()}원</div>
                        </div>
                    </div>
                `).join('');
            },

            renderDonate: function() {
                const list = document.getElementById('donate-list');
                let res = this.products.filter(p => p.type === 'donate');
                list.innerHTML = res.map(p => `
                    <div class="card" onclick="window.open('${p.link}')">
                        <div class="card-img-box"><img src="${p.img}" class="card-img"></div>
                        <div class="card-info">
                            <div class="card-tag" style="color:var(--primary)">무료나눔</div>
                            <div class="card-title">${p.title}</div>
                        </div>
                    </div>
                `).join('');
            }
        };
        window.app.init();
    </script>

    <script>
        function handleCredentialResponse(response) {
            try {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                const data = JSON.parse(jsonPayload);
                if (data.email) {
                    localStorage.setItem('useremail', data.email);
                    localStorage.setItem('username', data.name);
                    if (window.app) window.app.login();
                }
            } catch (e) { console.error("Login Error", e); }
        }
        document.addEventListener("DOMContentLoaded", () => {
            if(localStorage.getItem('useremail') && window.app) window.app.login();
        });
    </script>
</body>
</html>